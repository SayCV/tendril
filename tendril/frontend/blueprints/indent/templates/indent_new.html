{#
    Copyright (c) 2015 Chintalagiri Shashank
    Released under the MIT license
#}

{% extends "base_templates/base.html" %}

{% block main %}

<p></p>

<h4>{{ pagetitle }}</h4>

<div class="row">
    <form action="/inventory/indent/create" method="POST" data-abide>
    <div class="row" data-equalizer="fmain">
        <div class="small-12 large-5 columns" data-equalizer-watch="fmain">
            <fieldset>
                <legend>
                    Metadata
                </legend>
                <div class="row">
                    <div class="small-9 columns">
                        <label><span>Requested By</span>
                            <span class="right text-right"><small>Required</small></span>
                            <input name="user" id="user" type="text" value="{{ current_user.full_name }}"
                                   required list="json-userlist"
                                {% if not current_user.has_roles('inventory_admin') %}disabled{% endif %}>
                        </label>
                    </div>
                    <div class="small-3 columns">
                        <label><span>Date</span>
                            <span class="right text-right"><small>Required</small></span>
                            <input name="rdate" id="rdate" type="text" required
                                {% if not current_user.has_roles('inventory_admin') %}disabled{% endif %}>
                        </label>
                    </div>
                </div>
                <div class="row">
                    <div class="small-12 columns">
                        <label><span>Title</span>
                            <span class="right text-right"><small>Required</small></span>
                            <input name="indent_title" id="indent_title" type="text" required maxlength="40"
                            {% if stage.is_supplementary %}
                                   value="{{ stage.order_title }} Supplementary {{ stage.sidx }}"
                            {% endif %}>
                        </label>
                    </div>
                </div>
                <div class="row">
                    <div class="small-4 columns text-center">
                        <label class="small-12 columns text-center">Auto Generate</label>
                        <div class="small-12 columns switch radius small">
                            <input id="sno_generate" name="sno_generate" type="checkbox" checked
                                {% if not current_user.has_roles('inventory_admin') %}disabled{% endif %}>
                            <label for="sno_generate"></label>
                        </div>
                    </div>
                    <div class="small-8 columns">
                        <label><span>Serial Number</span>
                            <span class="right text-right"><small>Required</small></span>
                            <input name="indent_sno" id="indent_sno" type="text" disabled
                            {% if stage.is_supplementary %}
                                   value="{{ stage.parent_indent_sno }}.{{ stage.sidx }}"
                            {% endif %}>
                        </label>
                    </div>
                </div>
                <div class="row">
                    <div class="small-12 large-6 columns">
                        <label><span>Type</span>
                            <span class="right text-right"><small>Required</small></span>
                            <select name="indent_type" id="indent_type">
                              <option value="production">Production</option>
                              <option value="testing">Testing</option>
                              <option value="support">Support</option>
                              <option value="rd">Research & Development</option>
                            </select>
                        </label>
                    </div>
                    <div class="small-12 large-6 columns">
                        <label>Parent Indent
                            <input name="parent_indent_sno" id="parent_indent_sno" type="text" placeholder="Serial number of a parent indent"
                            {% if stage.is_supplementary %}
                                   value="{{ stage.parent_indent_sno }}"
                            {% endif %} disabled>
                        </label>
                    </div>
                    <div class="small-12 large-6 columns">
                        <label>Production Order
                            <input name="prod_order_sno" id="prod_order_sno" type="text"
                            {% if stage.is_supplementary %}
                                   value="{{ stage.prod_order_sno }}" disabled
                            {% endif %} placeholder="Specific production order" list="json-prodordlist">
                        </label>
                    </div>
                    <div class="small-12 large-6 columns">
                        <label>Root Order
                            <input name="root_order_sno" id="root_order_sno" type="text" placeholder="Top level SO or project code"
                            {% if stage.is_supplementary %}
                                   value="{{ stage.root_order_sno }}" disabled
                            {% endif %}>
                        </label>
                    </div>
                    <div class="small-12 columns">
                        <label><span>Indent For</span>
                            <span class="right text-right"><small>Required</small></span>
                            <input name="indent_desc" id="indent_desc" type="text" required>
                        </label>
                    </div>
                </div>
            </fieldset>
        </div>
        <div class="small-12 large-7 columns" data-equalizer-watch="fmain">
            <fieldset id="component-rows">
                <legend>
                    Components
                </legend>
                <!-- COBOM Input Starts -->
                <div class="row component-row">
                    <div class="small-8 columns">
                        <label>
                            <input name="ident[]" type="text" placeholder="Component" list="json-identlist">
                        </label>
                    </div>
                    <div class="small-3 columns">
                        <div class="row collapse postfix-radius">
                            <div class="small-6 columns">
                                <input name="qty[]" type="text" placeholder="Quantity">
                            </div>
                            <div class="small-6 columns">
                                <span class="postfix avail-qty"></span>
                            </div>
                        </div>
                    </div>
                    <div class="small-1 columns">
                        <a>
                            <div class="alert" id="delete-row[]">
                                <i class='fi-x'></i>
                            </div>
                        </a>
                    </div>
                </div>
                <a>
                    <div class="button success small expand radius" id="add-row">
                        Add Row
                    </div>
                </a>
                <!-- COBOM Input Ends -->
            </fieldset>
        </div>
    </div>
    <div class="small-12 large-4 columns">
        <!--<input type="submit" class="button small expand radius" value="Check Auth Chain" disabled>-->
    </div>
    <div class="small-12 large-4 columns">
        <!--<input type="submit" class="button small expand radius" value="Check Availability">-->
    </div>
    <div class="small-12 large-4 columns">
        <input type="submit" class="button alert small expand radius" value="Create Indent">
    </div>
    </form>
</div>

<script>

    $(document).ready( function () {

        <!-- Ident List Starts -->

        // Load in the library information
        var dataList = document.getElementById('json-identlist');
        var request = new XMLHttpRequest();

        // Handle state changes for the request.
        request.onreadystatechange = function(response) {
          if (request.readyState === 4) {
            if (request.status === 200) {
              // Parse the JSON
              var jsonOptions = JSON.parse(request.responseText);

              // Loop over the JSON array.
              jsonOptions.idents.forEach(function(item) {
                // Create a new <option> element.
                var option = document.createElement('option');
                // Set the value using the item in the JSON array.
                option.value = item;
                // Add the <option> element to the <datalist>.
                dataList.appendChild(option);
              });
            }
          }
        };

        request.open('GET', '/gsymlib/idents.json', true);
        request.send();

        <!-- Ident List Ends -->

        <!-- User List Starts -->

        // Load in the library information
        var userDataList = document.getElementById('json-userlist');
        var userRequest = new XMLHttpRequest();

        // Handle state changes for the request.
        userRequest.onreadystatechange = function(response) {
          if (userRequest.readyState === 4) {
            if (userRequest.status === 200) {
              // Parse the JSON
              var jsonOptions = JSON.parse(userRequest.responseText);

              // Loop over the JSON array.
              jsonOptions.users.forEach(function(item) {
                // Create a new <option> element.
                var option = document.createElement('option');
                // Set the value using the item in the JSON array.
                option.value = item;
                // Add the <option> element to the <datalist>.
                userDataList.appendChild(option);
              });
            }
          }
        };

        userRequest.open('GET', '/user/all.json', true);
        userRequest.send();

        <!-- User List Ends -->

        <!-- ProdOrd List Starts -->

        // Load in the library information
        var prodDataList = document.getElementById('json-prodordlist');
        var prodRequest = new XMLHttpRequest();

        // Handle state changes for the request.
        prodRequest.onreadystatechange = function(response) {
          if (prodRequest.readyState === 4) {
            if (prodRequest.status === 200) {
              // Parse the JSON
              var jsonOptions = JSON.parse(prodRequest.responseText);

              // Loop over the JSON array.
              jsonOptions.snos.forEach(function(item) {
                // Create a new <option> element.
                var option = document.createElement('option');
                // Set the value using the item in the JSON array.
                option.value = item.sno;
                <!--option.label = item.title;-->
                // Add the <option> element to the <datalist>.
                prodDataList.appendChild(option);
              });
            }
          }
        };

        prodRequest.open('GET', '/production/orders.json', true);
        prodRequest.send();

        <!-- ProdOrd List Ends -->

        <!-- COBOM Input Starts -->

        var $button = $('#add-row'),
            $row = $('.component-row').clone();

        $button.click(function() {
            $row.clone().insertBefore( $button );
            $(document).foundation('abide', 'reflow');
            $(document).foundation('reflow');
        });

        $("#component-rows").on("click", ".component-row #delete-row\\[\\]", function(){
            $( this ).closest('.component-row').remove();
            $(document).foundation('abide', 'reflow');
            $(document).foundation('reflow');
        });
        $("#component-rows").on("focusout", ".component-row input[name='ident\\[\\]']", function(){
            var ctx = this;
            $.ajax({
                 type: "POST",
                 url: "/inventory/location/status.json",
                 contentType: "application/json; charset=utf-8",
                 async: true,
                 data: JSON.stringify({ident: $( this ).val()}),
                 dataType: "json",
                 success: function(data){
                    $( ctx ).closest('.component-row').find('span').text(data.qty);
                 }
            });
        });

        <!-- COBOM Input Ends -->

        <!-- Serial No Form Elements -->
        var sno_field = $("#sno");
        $("#sno_generate").change(function(event) {
            var checkbox = event.target;
            if (checkbox.checked) {
                sno.disabled = true;
                sno.value = {% if stage.is_supplementary %}
                                   "{{ stage.parent_indent_sno }}.{{ stage.sidx }}"
                            {% else %}
                                    ""
                            {% endif %};
            } else {
                sno.disabled = false;
            }
        });
        <!-- Date picker elements -->
        $('#rdate').fdatepicker({
            format: 'dd/mm/yyyy',
        });
    });
</script>

<datalist id="json-identlist"></datalist>
<datalist id="json-userlist"></datalist>
<datalist id="json-prodordlist"></datalist>
{% endblock %}
