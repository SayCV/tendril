{#
    Copyright (c) 2015 Chintalagiri Shashank
    Released under the MIT license
#}

{% extends "base_templates/base.html" %}
{% import "parts/validation_errors.html" as validation %}
{% import "parts/costing_chart.html" as costing_chart %}

{% block magellan %}
<!-- Magellan -->
<div data-magellan-expedition="sticky">
    <dl class="sub-nav">
        <dd data-magellan-arrival="details"><a href="#details">Details</a></dd>
        <dd data-magellan-arrival="documentation"><a href="#documentation">Documentation</a></dd>
        <dd data-magellan-arrival="refbom"><a href="#refbom">BOM</a></dd>
        <dd data-magellan-arrival="modules"><a href="#modules">Modules</a></dd>
        {% if stage.product.changelog %}
            <dd data-magellan-arrival="changelog"><a href="#changelog">ChangeLog</a></dd>
        {% endif %}
        {% if stage.product.validation_errors.terrors %}
            <dd data-magellan-arrival="validation"><a href="#validation">Validation</a></dd>
        {% endif %}
        <dd data-magellan-arrival="costing"><a href="#costing">Costing</a></dd>
    </dl>
</div>
{% endblock %}


{% block main %}

<div class="row">

<h3> Product Detail </h3>

<div class="small-12 medium-6 columns">
    <div class="small-12 columns" data-magellan-destination="details">
        <a name="details"></a>
        <ul class="pricing-table shadow mrgn-20-top">
            <li class="price"> {{ stage.product.ident }} </li>
            <li class="description"> {{ stage.product.info.desc }} </li>
            {% if stage.product.info.status %}
              <span class="right label radius {{ stage.product.info.status.html_class }}">
                  {{ stage.product.info.status }}
              </span>
            {% endif %}
            {% if stage.product.info.line %}
              <span class="right label radius secondary">{{ stage.product.info.line }}</span>
            {% endif %}
            {% if stage.product.info.ptype %}
              <span class="right label radius secondary">{{ stage.product.info.ptype }}</span>
            {% endif %}
        </ul>
    </div>

    <div class="small-12 columns panel header radius" data-magellan-destination="modules">
        <a name="modules"></a>
        <div class="sign small-9 medium-6 small-centered columns autoscale">
            <h6>Product Contents</h6>
        </div>
        <div class="small-12 columns">
        {% for card, qty in stage.product.card_listing %}
            <a href="/entityhub/cards/{{ card }}">
            <div class="small-12 columns">
                <article class="product-content-info active-tb shadow mrgn-20-top">
                    <span class="product-content-label small-6 columns">
                        {{ card }}
                    </span>
                    <span class="product-content-qty small-6 columns">
                        {{ qty }}
                    </span>
                </article>
            </div>
            </a>
            {% endfor %}
            {% for cable, qty in stage.product.cable_listing %}
            <a href="/entityhub/cables/{{ cable }}">
            <div class="small-12 columns">
                <article class="product-content-info  active-tb shadow mrgn-20-top">
                    <span class="product-content-label small-6 columns">
                        {{ cable }}
                    </span>
                    <span class="product-content-qty small-6 columns">
                        {{ qty }}
                    </span>
                </article>
            </div>
            </a>
        {% endfor %}
        </div>
    </div>

    {% if stage.product.validation_errors.terrors %}
    <div class="small-12 columns" data-magellan-destination="validation">
        <a name="validation"></a>
        <div class="small-12 columns panel header radius">
            <div class="sign small-9 medium-6 small-centered columns autoscale">
                <h6>Validation Errors</h6>
            </div>
            {{ validation.render_validation_errors(stage.product.validation_errors) }}
        </div>
    </div>
    {% endif %}


</div>

<div class="small-12 medium-6 columns">
    <div class="small-12 columns panel header radius" data-magellan-destination="refbom">
        <a name="refbom"></a>
        <div class="sign small-9 medium-6 small-centered columns autoscale">
            <h6>Composite BOM</h6>
        </div>
        <div class="small-12 columns">
            <table id="refbom_table" class="display" data-paging='true'>
                <thead>
                <tr>
                    <th></th>
                    <th class="all">Ident</th>
                    <th class="all">Quantity</th>
                </tr>
                </thead>
                <tbody>
                {% for row in stage.product.obom.lines %}
                    <tr data-content="
                    <div class='dtchildslider'>
                    <table class='childtable'>
                    {% for col in row.collist %}
                        <tr>
                            <td> {{ col.0 }} </td>
                            <td class='text-center'> {{ col.1 }} </td>
                        </tr>
                    {% endfor %}
                    </table>
                    </div>
                    ">
                        <td class="details-control"></td>
                        <td> <a href="/gsymlib/detail/{{ row.ident }}"> {{ row.ident }} </a> </td>
                        <td class="text-center"> {{ row.quantity_str }} </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        <script type="text/javascript">
            $(document).ready( function () {
                var table = $('#refbom_table').DataTable({
                    /* Disable initial sort */
                    "aaSorting": [],
                    "lengthMenu": [[25, 50, 100, -1], [25, 50, 100, "All"]],
                    columnDefs:[{orderable: false, targets: [0]}],
                    {% include 'parts/datatable_defaults.html' %}
                });

                table.buttons().container()
                    .appendTo( '#refbom_table_wrapper .small-12.medium-6.columns:eq(0)' )
                    .addClass('small-12 columns no-padding');

                $('#refbom_table tbody').on('click', 'td.details-control', function () {
                    var tr = $(this).closest('tr');
                    var row = table.row( tr );
                    if ( row.child.isShown() ) {
                        // This row is already open - close it
                        $('div.dtchildslider', row.child()).slideUp( function () {
                            row.child.hide();
                            tr.removeClass('shown');
                        });
                    }
                    else {
                        // Open this row
                        row.child( tr.attr('data-content'), 'no-padding').show();
                        tr.addClass('shown');
                        $('div.dtchildslider', row.child()).slideDown();
                    }
                });
            });
        </script>
    </div>
</div>

<!-- BOM -->

<div class="small-12 columns" data-magellan-destination="costing">
    <a name="costing"></a>
    {{ costing_chart.render_indicative_costing_chart(stage.product) }}
</div>

</div>
{% endblock %}
