{#
    Copyright (c) 2015 Chintalagiri Shashank
    Released under the MIT license
#}

{% extends "base_templates/base.html" %}

{% block magellan %}
<!-- Magellan -->
<div data-magellan-expedition="sticky">
    <dl class="sub-nav">
        <dd data-magellan-arrival="details"><a href="#details">Details</a></dd>
        <dd data-magellan-arrival="documentation"><a href="#documentation">Documentation</a></dd>
        <dd data-magellan-arrival="changelog"><a href="#changelog">ChangeLog</a></dd>
        <dd data-magellan-arrival="costing"><a href="#costing">Costing</a></dd>
        <dd data-magellan-arrival="configurations"><a href="#configurations">Configurations</a></dd>
    </dl>
</div>
{% endblock %}


{% block main %}

<div class="row">
<div class="small-12 medium-6 columns" data-magellan-destination="details">
<h3> PCB Details </h3>
<a name="details"></a>
        <ul class="pricing-table shadow mrgn-20-top">
            <li class="price autoscale "> {{ stage.name }} </li>
            <li class="description"> {{ stage.configdata.description() }} </li>
            <li class="title"> PCB Details </li>
            {% for descriptor in stage.configdata.pcbdescriptors %}
            <li class="bullet-item"> {{ descriptor }} </li>
            {% endfor %}
            {% if stage.configdata.configdata.grouplist %}
            <li class="title"> Groups </li>
            {% for group in stage.configdata.configdata.grouplist %}
            <li class="bullet-item">
                <b> {{ group.name }} : </b> {{ group.desc }}
            </li>
            {% endfor %}
            {% endif %}
            {% if stage.prototype.status %}
              <span class="right label radius {{stage.prototype.status.html_class}}">
                  {{stage.prototype.status}}
              </span>
            {% endif %}
        </ul>
</div>

<!-- Documentation -->
<div class="small-12 medium-6 columns">
<h3> Documentation </h3>
<a name="documentation"></a>
    <ul class="doclinklist">
        {% for doc in stage.docs %}
            {% include 'parts/doc_link_list_element.html' %}
        {% endfor %}
    </ul>
</div>
</div>

<!-- Rendering of Image -->
<div class="row">
    <ul class="large-block-grid-3 clearing-thumbs" data-clearing>
        {% for img in stage.imgs %}
        <li>
          <a class="th" href="{{ img.exposed_url }}">
              <img data-caption="{{ img.desc }}" src="{{ img.exposed_url }}" />
          </a>
        </li>
        {% endfor %}
    </ul>
</div>

<!--ChangeLog and Issues-->
<div class="row">
    {% if stage.prototype.changelog %}
    <div class="small-12 medium-6 columns" data-magellan-destination="changelog">
        <a name="changelog"></a>
        <div class="small-12 columns panel header radius">
            <div class="sign small-9 medium-6 small-centered columns autoscale">
                <h6>ChangeLog</h6>
            </div>
            {% set changelog = stage.prototype.changelog.parts %}
            {% include 'parts/changelog.html' %}
        </div>
    </div>
{% endif %}
</div>


<div class="row" data-equalizer="costing">
<!-- Pricing Information -->
    {% if stage.costing %}
    <div class="small-12 medium-6 columns panel header radius" data-equalizer-watch="costing">
        <div class="sign small-9 medium-6 small-centered columns autoscale">
            <h6>Costing</h6>
            <a name="costing"></a>
        </div>
        <div class="small-12 columns">
        <div id="pcb-pricing-chart" class="cleanchart">
            <svg style="width: 100%; height: 300px;"></svg>
        </div>
        </div>
    </div>
    <script type="text/javascript">
    $(document).ready( function () {
        nv.addGraph(function() {
          var chart = nv.models.multiChart()
                      .margin({left: 70, right: 75})  //Adjust chart margins to give the x-axis some breathing room.
                      //.useInteractiveGuideline(true)
                      //.showYAxis(true)     //Show the y-axis
                      //.showXAxis(true)     //Show the x-axis
                      .showLegend(false)
          ;

          chart.xAxis
            .axisLabel('Quantity')
            .tickFormat(d3.format(',d'))
            ;

          chart.yAxis1
            .axisLabel('Unit Price')
            .tickFormat(function (d) {
               return  '{{ stage.costing.csymbol|unicode }}' + d;
            });

          chart.yAxis2
            .axisLabel('Total Price')
            .tickFormat(function (d) {
               return  '{{ stage.costing.csymbol|unicode }}' + d;
            });

          d3.select('#pcb-pricing-chart svg')
            .datum({{ stage.costing.data|safe }})
            .transition().duration(500)
            .call(chart)
            ;

          nv.utils.windowResize(chart.update);

          return chart;
        });
    });

    </script>
    {% endif %}

<!-- Inventory Information -->
    <div class="small-12 medium-6 columns" data-equalizer-watch="costing">
        <div class="small-12 columns panel header radius">
            <div class="sign small-9 medium-6 small-centered columns autoscale">
                <h6>Inventory Status</h6>
            </div>
            <div class="small-12 columns">
                <table id="inv_status_table" class="display" data-paging='false'>
                    <thead>
                    <tr>
                        <th class="all">Inventory Location</th>
                        <th class="desktop">Quantity</th>
                        <th class="desktop">Reserved</th>
                        <th class="all">Available</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for code, status in stage.inv_loc_status|dictsort %}
                        <tr>
                            <td> <a href="/inventory/location/{{ code }}">{{ status.0 }}</a> </td>
                            <td class="text-center"> {{ status.1 or '-' }} </td>
                            <td class="text-center"> {{ status.2 or '-' }} </td>
                            <td class="text-center"> {{ status.3 or '-' }} </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td> <b> TOTAL </b> </td>
                            <td class="text-center"><b>{{ stage.inv_total_quantity }}</b></td>
                            <td class="text-center"><b>{{ stage.inv_total_reservations }}</b></td>
                            <td class="text-center"><b>{{ stage.inv_total_availability }}</b></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <script type="text/javascript">
                $(document).ready( function () {
                    var table = $('#inv_status_table').DataTable({
                        /* Disable initial sort */
                        "aaSorting": [],
                        "info": false,
                        {% include 'parts/datatable_defaults.html' %}
                    });
                    table.buttons().container()
                        .appendTo( '#inv_status_table_wrapper .small-12.medium-6.columns:eq(0)' );
                });
            </script>
        </div>
    </div>
<!-- Product Utilization Information -->
</div>

<div class="row" data-magellan-destination="configurations">
<a name="configurations"></a>
<div class="small-12 columns panel header radius">
    <div class="sign small-9 medium-6 small-centered columns autoscale">
        <h6>Configurations</h6>
    </div>
    <div class="small-12 columns">
        <ul class="small-block-grid-1 medium-block-grid-2 large-block-grid-3">
    {% for configuration in stage.configurations %}
        <li>
        <a href="/entityhub/cards/{{configuration.ident}}">
        <ul class="pricing-table active-tb shadow mrgn-20-top">
            <li class="title"> {{ configuration.ident }} </li>
            <li class="description"> {{ configuration.desc }} </li>
            {% if configuration.status %}
              <span class="right label radius {{ configuration.status.html_class }}">
                  {{ configuration.status }}
              </span>
            {% endif %}
            {% if configuration.sourcing_errors %}
              <span class="left label radius alert">
                  {{ configuration.sourcing_errors.terrors }} Sourcing Errors
              </span>
            {% endif %}
        </ul>
        </a>
        </li>
    {% endfor %}
        </ul>
    </div>
    {% if stage.configurations|length > 1 %}
    <div class="small-12 columns">
        <div id="comparative-costing-chart" class="cleanchart">
            <svg style="width: 100%; height: {{ (stage.configurations|length * 40) + 100 }}px"></svg>
        </div>
        <script type="text/javascript">
            $(document).ready( function () {
                function get_data() {
                    return {{ stage.configurations_costing|safe }}
                 }

                nv.addGraph(function() {
                  var costing_chart = nv.models.multiBarHorizontalChart()
                                      .x( function(d) { return d.label } )
                                      .y( function(d) { return d.value } )
                                      .duration(250)
                                      .margin({left: 150})
                                      .showControls(false)
                                      .showLegend(false)
                                      .stacked(true)
                                      ;

                  costing_chart.yAxis
                      .tickFormat(function(d) {
                          if (d >= 0){
                            return "{{ stage.native_currency_symbol|unicode }}" + d3.format(",.2f")(d);
                          }
                          else{
                            return Math.log2(-d) + ' idents';
                          };
                      })
                  ;


                  d3.select('#comparative-costing-chart svg')
                    .datum(get_data())
                    .transition().duration(500)
                    .call(costing_chart)
                    ;

                  nv.utils.windowResize(costing_chart.update);
                  return costing_chart;
                });
            });
        </script>
    </div>
    {% endif %}
</div>

</div>
{% endblock %}


<!--
{% if stage.configdata.configdata.motiflist %}
            <li class="title"> Motifs </li>
            {% for key, value in stage.configdata.configdata.motiflist|dictsort %}
            <li class="bullet-item">
                <b> {{ key }} : </b> {{ value.desc }}
            </li>
            <li>
            <ul class="small-block-grid-3 small-11 columns small-centered">
                {% for p, s in value.iteritems() %}
                    {% if p != 'desc' %}
                        <li class="description"> {{ p|upper }} : {{ s }} </li>
                    {% endif %}
                {% endfor %}
            </ul>
            </li>
            {% endfor %}
            {% endif %}
            {% if stage.configdata.configdata.sjlist %}
            <li class="title"> SJs </li>
            <li class="bullet-item">
                <ul class="small-block-grid-3">
                {% for key, value in stage.configdata.configdata.sjlist|dictsort %}
                <li><b> {{ key }} : </b> {{ value }}</li>
                {% endfor %}
                </ul>
            </li>
            {% endif %}
-->
