{#
    Copyright (c) 2015 Chintalagiri Shashank
    Released under the MIT license
#}

{% extends "base_templates/base.html" %}

{% block magellan %}
<!-- Magellan -->
<div data-magellan-expedition="sticky">
    <dl class="sub-nav">
        <dd data-magellan-arrival="documentation"><a href="#documentation">Download</a></dd>
        <dd data-magellan-arrival="results"><a href="#documentation">Results</a></dd>
        <dd data-magellan-arrival="graphs"><a href="#documentation">Graphs</a></dd>
        <dd data-magellan-arrival="instruments"><a href="#documentation">Instruments</a></dd>
    </dl>
</div>
{% endblock %}

{% block main %}

<p></p>

<h3> {{ stage.docs[0].filename|replace('TEST-REPORT-', '') }} Test & Calibration Report </h3>
<!-- TODO Make the tables responsive and improve the layout -->
<div class="row">
<!-- Metadata -->
<div class="small-12 medium-6 columns">
<a name="metadata"></a>
    <div class="small-12 columns">
        <table id="metadata_table" class="display" width="100%">
            <tbody>
                <tr>
                    <td class="dt-right" scope="row"> Model </td>
                    <td> <b>{{ stage.devicetype }}</b> </td>
                </tr>
                <tr>
                    <td class="dt-right" scope="row"> Serial No. </td>
                    <td> <b>{{ stage.sno }}</b> </td>
                </tr>
                <tr>
                    <td class="dt-right" scope="row"> Test Definitions </td>
                    <td> R{{ stage.svnrevision }} configs </td>
                </tr>
                <tr>
                    <td class="dt-right" scope="row"> Test Date </td>
                    <td> {{ stage.testdate }} </td>
                </tr>
                <tr>
                    <td colspan="2">
                        {{ stage.desc }}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <!-- TODO colspan breaks datatables -->
    <!--<script type="text/javascript">-->
        <!--$(document).ready( function () {-->
            <!--var table = $('#metadata_table').DataTable({-->
                <!--/* Disable initial sort */-->
                <!--"aaSorting": [],-->
                <!--responsive: true,-->
                <!--"bAutoWidth": false,-->
                <!--"paging": false,-->
                <!--"ordering": false,-->
                <!--"info": false,-->
                <!--"searching": false,-->
            <!--});-->
        <!--});-->
    <!--</script>-->
</div>


<!-- Downloads -->
<div class="small-12 medium-6 columns">
<h4> Download </h4>
<a name="documentation"></a>
    <ul class="doclinklist">
        {% for doc in stage.docs %}
            {% include 'parts/doc_link_list_element.html' %}
        {% endfor %}
    </ul>
</div>
</div>

<!-- Result -->
<script type="text/javascript">
    var details = {};

    /* Formatting function for row details */
    function format ( d ) {
        // `d` is the original data object for the row
        if (!d){
            return '';
        }
        var rval = '<div class="large-6 medium-12 columns">'
        rval += '<table class="embedtable" width="100%" cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">';
        if (d.lines){
            for(var i=0, len=d.lines.length; i < len; i++){
                rval += '<tr><td>' + d.lines[i].desc + '</td>'
                        + '<td class="text-center">' + d.lines[i].expected + '</td>'
                        + '<td class="text-center">' + d.lines[i].measured + '</td>'
                        + '</tr>';
            }
            rval += '</table></div>';
            if (d.instrument){
                rval += '<div class="large-5 medium-12 columns">Instrument : ';
                rval += d.instrument + ' ' + d.inststr + '</div>';
            }
        }
        return rval;
    }


</script>

<div class="small-12 columns">
<h4> Test Result </h4>
<a name="results"></a>
<div class="small-12 columns">

        {% for suite in stage.suites %}
        <table id="suite_table_{{ loop.index }}" class="responsive cleantable row-border" width="100%">
            <thead>
            <tr>
                <th class="all"></th>
                <th class="all">{{ suite.desc }}</th>
                <th> </th>
                <th class="all">{{ suite.title }}</th>
                <th class="desktop">{{ suite.ts }}</th>
                <th class="all text-center
                {% if suite.passed == 'PASSED' %}
                    resulthead-pass
                {% elif suite.passed == 'FAILED' %}
                    resulthead-fail
                {% endif %}">{{ suite.passed }}</th>
            </tr>
            </thead>
            <tbody>
            {% for test in suite.tests %}
                <tr data-id='{{ test.desc }}'>
                    <td> {{ loop.index }} </td>
                    <td> {{ test.desc }} </td>
                    <td class="details-control"> </td>
                    <td> {{ test.title }} </td>
                    <td> {{ test.ts }} </td>
                    <td class="text-center
                    {% if test.passed == 'PASSED' %}
                        resultcell-pass
                    {% elif test.passed == 'FAILED' %}
                        resultcell-fail
                    {% endif %}
                    ">{{ test.passed }}</td>

                    <script>
                    {% if test.lines %}
                    details['{{test.desc}}'] = {};
                    details['{{test.desc}}']['lines'] = [
                        {% for l in test.lines %}
                            {'desc': '{{ l.desc }}',
                             {% if l.expected %}
                             'expected': '{{ l.expected|latex_render|safe }}',
                             {% else %}
                             'expected': '',
                             {% endif %}
                             'measured': '{{ l.measured|latex_render|safe }}'
                             },
                        {% endfor %}
                     ];
                    {% if test.instrument %}
                    details['{{test.desc}}']['instrument'] = '{{ stage.instruments.get(test.instrument) }}';
                    details['{{test.desc}}']['inststr'] = '{{ test.instrument }}';
                    {% endif %}
                    {% endif %}
                    </script>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        <script type="text/javascript">
        $(document).ready( function () {
            var table = $('#suite_table_{{ loop.index }}').DataTable({
                "aaSorting": [],
                responsive: true,
                "paging": false,
                "ordering": false,
                "info": false,
                "searching": false,
                "columnDefs":[
                    {"width": "1em", "targets": 0},
                    {"width": "10em", "targets": 1},
                    {"width": "12em", "targets": 4},
                    {"width": "7em", "targets": 5},
                ],
            });

            // Add event listener for opening and closing details
            $('#suite_table_{{ loop.index }} tbody').on('click', 'td.details-control', function () {
                var tr = $(this).closest('tr');
                var data_id = tr.attr('data-id');
                var row = table.row( tr );

                if ( row.child.isShown() ) {
                    // This row is already open - close it
                    row.child.hide();
                    tr.removeClass('shown');
                }
                else {
                    // Open this row
                    row.child( format(details[data_id]) ).show();
                    tr.addClass('shown');
                }
            });
        });
    </script>
        {% endfor %}

    </div>
</div>

<!-- Instrument -->
<div class="row">
<div class="small-12 medium-6 columns">
    <a name="instruments"></a>
    <div class="small-12 columns">
        <h5> Instruments </h5>
    </div>
    <div class="small-12 columns">
        <table id="instruments_table" class="display" width="100%">
            <thead>
            <tr>
                <th class="all">IDX</th>
                <th class="all">Instrument</th>
            </tr>
            </thead>
            <tbody>
            {% for instrument in stage.instruments|dictsort(False, 'value') %}
                <tr>
                    <td> {{ instrument.1 }} </td>
                    <td> {{ instrument.0 }} </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <script type="text/javascript">
        $(document).ready( function () {
            var table = $('#instruments_table').DataTable({
                /* Disable initial sort */
                "aaSorting": [],
                responsive: true,
                "paging": false,
                "ordering": false,
                "info": false,
                "searching": false,
            });
        });
    </script>
</div>
</div>

<!-- Graphs -->
{% endblock %}
